<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>YMIR Guild - Panel</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
  <h1>Panel de Miembros</h1>

  <div class="nav">
    <a href="panel.html" class="active">Miembros</a>
    <a href="subastas.html">Subastas</a>
    <a href="registro.html">Historial</a>
    <a href="control.html">Control Semanal</a>
    <span id="solicitudesBtn" style="display:none">
      <a href="solicitudes.html">Solicitudes</a>
    </span>
  </div>

  <div class="card">
    <table id="tablaMiembros"></table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* === Firebase === */
initializeApp({
  apiKey: "AIzaSyBt9Kqhw6V1l5ZkQLK5FKxmeW1kQ68LIbE",
  authDomain: "registro-de-guild-en-ymir.firebaseapp.com",
  projectId: "registro-de-guild-en-ymir"
});
const auth = getAuth();
const db = getFirestore();

/* === Mostrar botÃ³n de Solicitudes solo si el rol es Lider u Oficial === */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  const docRef = doc(db, "members", user.uid);
  const snap = await getDoc(docRef);
  const rol = snap.exists() ? (snap.data().rol || snap.data().proofImages?.role || "").toLowerCase() : "";

  if (rol === "lider" || rol === "oficial") {
    document.getElementById("solicitudesBtn").style.display = "inline";
  }

  cargarMiembros();
});

/* === Cargar miembros en tiempo real === */
function cargarMiembros(){
  const tabla = document.getElementById("tablaMiembros");
  onSnapshot(collection(db,"members"), snap => {
    tabla.innerHTML = `
      <tr>
        <th>Nombre</th>
        <th>Clase</th>
        <th>Nivel</th>
        <th>Poder</th>
        <th>Rol</th>
      </tr>
    `;
    snap.forEach(d=>{
      const u = d.data();
      tabla.innerHTML += `
        <tr>
          <td>${u.name || "-"}</td>
          <td>${u.clase || "-"}</td>
          <td>${u.nivel || "-"}</td>
          <td>${u.poder || "-"}</td>
          <td>${u.rol || u.proofImages?.role || "-"}</td>
        </tr>
      `;
    });
  });
}
</script>

</body>
</html>
