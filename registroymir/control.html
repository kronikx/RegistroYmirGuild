<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>YMIR Guild - Historial</title>
<link rel="stylesheet" href="style.css">
<style>
  /* === Bot√≥n Exportar a Excel === */
  .export-excel-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    display: none; /* Oculto por defecto, se mostrar√° solo para l√≠deres/oficiales */
  }

  .export-excel-btn {
    background: linear-gradient(135deg, #0f9d58, #34a853);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 12px 24px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
  }

  .export-excel-btn:hover {
    background: linear-gradient(135deg, #0b8043, #2e8b57);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
  }

  .export-excel-btn:active {
    transform: translateY(0);
  }

  .export-excel-btn .icon {
    font-size: 16px;
  }
  
  /* Estilos para el bot√≥n de filtros */
  .filters {
    margin-bottom: 15px;
    text-align: center;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    align-items: center;
  }
  
  .filters .btn {
    padding: 8px 16px;
    font-size: 14px;
    margin: 2px;
  }
</style>
</head>
<body>

<!-- Secci√≥n superior: Hora y URL -->
<div class="header-info">
  <div class="time-section">
    <div>
      <span class="time-label">Hora Local:</span>
      <span class="time-display" id="localTime">--:--:--</span>
    </div>
    <div>
      <span class="time-label">Hora Servidor:</span>
      <span class="time-display" id="serverTime">--:--:--</span>
    </div>
  </div>
  

<!-- Men√∫ de navegaci√≥n -->
<nav class="menu">
  <ul class="menu-nav">
    <li class="menu-item">
      <a href="panel.html" class="menu-link">
        <span>üë•</span>
        Miembros
      </a>
    </li>
    <li class="menu-item">
      <a href="subastas.html" class="menu-link">
        <span>üí∞</span>
        Subastas
      </a>
    </li>
    <li class="menu-item">
      <a href="registro.html" class="menu-link active">
        <span>üìã</span>
        Historial
      </a>
    </li>
    <li class="menu-item">
      <a href="control.html" class="menu-link">
        <span>üéÆ</span>
        Control
      </a>
    </li>
    <li class="menu-item">
      <a href="solicitudes.html" class="menu-link" style="position:relative;">
        <span>üì®</span>
        Solicitudes
        <span class="solicitudes-badge" id="solicitudesBadge"></span>
      </a>
    </li>
  </ul>
</nav>

<div class="container">
  <h1>Historial del Clan</h1>

  <div class="card">
    <div class="filters" style="margin-bottom: 15px;">
      <button class="btn" onclick="filtrar('todos')">Todos</button>
      <button class="btn secondary" onclick="filtrar('poder')">Poder/Nivel</button>
      <button class="btn secondary" onclick="filtrar('semanal')">Semanal</button>
      <button class="btn secondary" onclick="filtrar('Puja')">Pujas</button>
      <button class="btn secondary" onclick="filtrar('boss')">Boss</button>
      <button class="btn secondary" onclick="filtrar('reinicio')">Reinicio</button>
    </div>
    <div class="table-scroll">
      <table id="tablaHistorial"></table>
    </div>
  </div>
</div>

<!-- Bot√≥n flotante para exportar a Excel -->
<div class="export-excel-container">
  <button class="export-excel-btn" onclick="exportarHistorialAExcel()">
    <span class="icon">üìä</span>
    Exportar Historial
  </button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  getDocs, 
  orderBy, 
  query,
  doc,
  getDoc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* === Firebase === */
initializeApp({
  apiKey: "AIzaSyBt9Kqhw6V1l5ZkQLK5FKxmeW1kQ68LIbE",
  authDomain: "registro-de-guild-en-ymir.firebaseapp.com",
  projectId: "registro-de-guild-en-ymir"
});
const db = getFirestore();
const auth = getAuth();

/* === Variables globales === */
let registros = [];
let esLiderOficial = false;
let MI_ROL = "Miembro";

/* === Actualizar relojes superiores === */
function updateTopClocks() {
  const now = new Date();
  
  const localTime = now.toLocaleTimeString('es-ES', { hour12: false });
  document.getElementById('localTime').textContent = localTime;
  
  const serverTime = new Date(now.getTime() - (3 * 3600 * 1000));
  const serverTimeStr = serverTime.toISOString().substr(11, 8);
  document.getElementById('serverTime').textContent = serverTimeStr;
}

setInterval(updateTopClocks, 1000);
updateTopClocks();

/* === Auth y verificaci√≥n de rol === */
onAuthStateChanged(auth, async user=>{
  if(!user){ 
    location.href = "index.html"; 
    return; 
  }
  
  const meRef = doc(db,"members",user.uid);
  const meSnap = await getDoc(meRef);
  
  if(meSnap.exists()){
    MI_ROL = meSnap.data()?.role || "Miembro";
    const rolLower = MI_ROL.trim().toLowerCase();
    esLiderOficial = (rolLower === "l√≠der" || rolLower === "lider" || rolLower === "oficial");
    
    // Mostrar/ocultar bot√≥n de exportaci√≥n seg√∫n rol
    const exportarFloatingBtn = document.querySelector(".export-excel-container");
    if (exportarFloatingBtn) {
      exportarFloatingBtn.style.display = esLiderOficial ? "block" : "none";
    }
  }
  
  // Cargar historial despu√©s de verificar autenticaci√≥n
  cargarHistorial();
});

/* === Cargar historial === */
async function cargarHistorial(){
  const q = query(collection(db,"historial"), orderBy("fecha","desc"));
  const snap = await getDocs(q);

  registros = [];
  snap.forEach(d=>{
    registros.push(d.data());
  });

  pintarTabla(registros);
}

function pintarTabla(lista){
  const tabla = document.getElementById("tablaHistorial");

  if(lista.length===0){
    tabla.innerHTML = `<tr><td colspan="5">No hay registros</td></tr>`;
    return;
  }

  tabla.innerHTML = `
    <tr>
      <th>Usuario</th>
      <th>Rol</th>
      <th>Acci√≥n</th>
      <th>Cambio</th>
      <th>Fecha</th>
    </tr>
  `;

  lista.forEach(h=>{
    let badgeClass = "";
    if(h.accion.includes("poder") || h.accion.includes("nivel")){
      badgeClass = "badge badge-poder";
    }else if(h.accion.includes("semanal")){
      badgeClass = "badge badge-semanal";
    }else if(h.accion.includes("Puja")){
      badgeClass = "badge badge-puja";
    }else if(h.accion.includes("boss") || h.accion.includes("Boss")){
      badgeClass = "badge badge-boss";
    }else if(h.accion.includes("Reinicio")){
      badgeClass = "badge badge-reinicio";
    }

    tabla.innerHTML += `
      <tr>
        <td>${h.usuario}</td>
        <td>${h.rol ? h.rol : "-"}</td>
        <td><span class="${badgeClass}">${h.accion}</span></td>
        <td>${h.cambio}</td>
        <td>${new Date(h.fecha).toLocaleString()}</td>
      </tr>
    `;
  });
}

/* === Filtro === */
window.filtrar = (tipo)=>{
  if(tipo==="todos"){
    pintarTabla(registros);
    return;
  }
  const filtrados = registros.filter(h=>{
    if(tipo==="poder") return h.accion.includes("poder") || h.accion.includes("nivel");
    if(tipo==="semanal") return h.accion.includes("semanal");
    if(tipo==="Puja") return h.accion.includes("Puja");
    if(tipo==="boss") return h.accion.includes("boss") || h.accion.includes("Boss");
    if(tipo==="reinicio") return h.accion.includes("Reinicio");
    return true;
  });
  pintarTabla(filtrados);
};

/* === Exportar historial a Excel === */
window.exportarHistorialAExcel = async () => {
  if(!esLiderOficial){
    alert("‚ùå Solo L√≠deres y Oficiales pueden exportar el historial.");
    return;
  }
  
  try {
    // Mostrar indicador de carga
    const btn = document.querySelector('.export-excel-btn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="icon">‚è≥</span> Generando...';
    btn.disabled = true;
    
    // Obtener datos de historial
    const q = query(collection(db,"historial"), orderBy("fecha","desc"));
    const snap = await getDocs(q);
    
    // Crear encabezados del CSV
    const headers = [
      'Fecha Completa', 'Fecha', 'Hora', 'Usuario', 'Rol', 
      'Acci√≥n', 'Cambio', 'Timestamp'
    ];
    
    // Crear filas de datos
    const rows = [headers];
    
    snap.forEach(doc => {
      const h = doc.data();
      const fechaCompleta = new Date(h.fecha);
      const fecha = fechaCompleta.toLocaleDateString('es-ES');
      const hora = fechaCompleta.toLocaleTimeString('es-ES');
      
      rows.push([
        fechaCompleta.toLocaleString('es-ES'),
        fecha,
        hora,
        h.usuario || '',
        h.rol || '',
        h.accion || '',
        h.cambio || '',
        h.fecha || ''
      ]);
    });
    
    // Convertir a CSV
    const csvContent = rows.map(row => 
      row.map(cell => {
        // Escapar comillas y formatear
        const cellStr = String(cell);
        // Si contiene comas, comillas o saltos de l√≠nea, envolver en comillas
        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
          return `"${cellStr.replace(/"/g, '""')}"`;
        }
        return cellStr;
      }).join(',')
    ).join('\n');
    
    // Crear y descargar archivo
    const fecha = new Date().toISOString().split('T')[0];
    const hora = new Date().toLocaleTimeString('es-ES', { hour12: false }).replace(/:/g, '-');
    const nombreArchivo = `YMIR_Historial_${fecha}_${hora}.csv`;
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = nombreArchivo;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert(`‚úÖ Exportaci√≥n completada!\n\nüìä ${rows.length - 1} registros exportados\nüìÇ Archivo: ${nombreArchivo}\n\n1. Descarga el archivo CSV\n2. √Åbrelo con Excel\n3. O p√©galo en Google Sheets`);
    
  } catch (error) {
    console.error('Error al exportar:', error);
    alert(`‚ùå Error al exportar: ${error.message}`);
  } finally {
    // Restaurar bot√≥n
    const btn = document.querySelector('.export-excel-btn');
    if (btn) {
      btn.innerHTML = '<span class="icon">üìä</span> Exportar Historial';
      btn.disabled = false;
    }
  }
};

/* === Punto rojo en nav === */
function escucharSolicitudesBadge(){
  const q = collection(db,"solicitudes");
  const unsubscribe = onSnapshot(q, snap=>{
    const badge = document.getElementById("solicitudesBadge");
    if(!badge) return;
    badge.style.display = snap.size > 0 ? "block" : "none";
  });
  
  // Llamar a la funci√≥n para empezar a escuchar
  escucharSolicitudesBadge();
}

// Inicializar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
  updateTopClocks();
});
</script>

</body>
</html>