<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>YMIR Guild - Subastas</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
  <h1>Subastas del Clan</h1>

  <div class="nav">
    <a href="panel.html">Miembros</a>
    <a href="subastas.html">Subastas</a>
    <a href="registro.html">Historial</a>
    <a href="panel.html">Volver</a>
  </div>

  <!-- Crear subasta (solo LÃ­der/Oficial) -->
  <div class="card" id="crearSubasta" style="display:none">
    <h3>Nueva Subasta</h3>
    <input id="item" placeholder="Nombre del item">
    <input id="imagen" placeholder="URL imagen (opcional)">
    <input id="precio" type="number" placeholder="Precio base">
    <input id="tiempo" type="number" placeholder="Minutos">
    <button id="crear">Crear subasta</button>
    <p id="crearMsg" style="text-align:center; color:#c77dff; margin-top:10px;"></p>
  </div>

  <!-- Contenedor tabla + saldo (no se modifican estilos de la tabla) -->
  <div class="card" style="display:flex; align-items:flex-start; gap:20px;">
    <!-- Tabla de subastas -->
    <table id="tabla" style="flex:1"></table>

    <!-- Cuadro de saldo a la derecha -->
    <div style="border:1px solid #ccc; padding:10px; border-radius:6px; min-width:180px; text-align:center;">
      <button id="saldoBtn" disabled style="font-weight:bold; width:100%;">Mis puntos: 0</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  doc,
  getDoc,
  updateDoc,
  deleteDoc,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* === Firebase === */
initializeApp({
  apiKey: "AIzaSyBt9Kqhw6V1l5ZkQLK5FKxmeW1kQ68LIbE",
  authDomain: "registro-de-guild-en-ymir.firebaseapp.com",
  projectId: "registro-de-guild-en-ymir"
});
const auth = getAuth();
const db = getFirestore();

/* === Auth y visibilidad del creador === */
onAuthStateChanged(auth, async user=>{
  if(!user){
    location.href = "index.html";
    return;
  }
  const meSnap = await getDoc(doc(db,"members",user.uid));
  const role = meSnap.data()?.role || "Miembro";
  if(role==="LÃ­der" || role==="Oficial"){
    document.getElementById("crearSubasta").style.display = "block";
  }
  escucharSaldo();
  cargarSubastas();
});

/* === Saldo en tiempo real (actualiza el botÃ³n a la derecha) === */
function escucharSaldo(){
  const user = auth.currentUser;
  if(!user) return;
  onSnapshot(doc(db,"members",user.uid), (snap)=>{
    const data = snap.data();
    document.getElementById("saldoBtn").textContent = `Mis puntos: ${data?.totalContribution ?? 0}`;
  });
}

/* === Crear subasta === */
document.getElementById("crear").onclick = async ()=>{
  const item = document.getElementById("item").value.trim();
  const imagen = document.getElementById("imagen").value.trim();
  const precio = Number(document.getElementById("precio").value);
  const tiempo = Number(document.getElementById("tiempo").value);

  if(!item || !precio || !tiempo){
    document.getElementById("crearMsg").textContent = "Completa todos los campos obligatorios";
    return;
  }

  try{
    await addDoc(collection(db,"subastas"),{
      item,
      imagen: imagen || "",
      precioBase: precio,
      pujaActual: precio,
      ganador: "",
      ganadorUid: "",
      fin: Date.now() + tiempo * 60000,
      finalizada: false,
      historial: [] // [{ uid, jugador, cantidad }]
    });
    document.getElementById("crearMsg").textContent = "Subasta creada correctamente";
    // onSnapshot repintarÃ¡ la tabla
  }catch(e){
    document.getElementById("crearMsg").textContent = "Error al crear la subasta: " + e.message;
  }
};

/* === Tabla de subastas en tiempo real (no se tocan estilos de la tabla) === */
function cargarSubastas(){
  const tabla = document.getElementById("tabla");
  const user = auth.currentUser;
  if(!user) return;

  onSnapshot(collection(db,"subastas"), async (snap) => {
    const me = await getDoc(doc(db,"members",user.uid));
    const role = me.data()?.role || "Miembro";
    const puedeBorrar = (role==="LÃ­der" || role==="Oficial");

    if(snap.empty){
      tabla.innerHTML = `<tr><td colspan="${puedeBorrar ? 8 : 7}">No hay subastas activas</td></tr>`;
      return;
    }

    tabla.innerHTML = `
      <tr>
        <th>Item</th>
        <th>Precio base</th>
        <th>Puja actual</th>
        <th>Ganador</th>
        <th>Tiempo</th>
        <th>Historial</th>
        <th>Pujar</th>
        ${puedeBorrar ? "<th>Eliminar</th>" : ""}
      </tr>
    `;

    snap.forEach(d=>{
      const s = d.data();
      const restante = Math.max(0, Math.floor((s.fin - Date.now()) / 1000));
      const historialTxt = s.historial && s.historial.length 
        ? s.historial.map(h=>`${h.jugador} â†’ ${h.cantidad}`).join("<br>")
        : "-";

      tabla.innerHTML += `
        <tr>
          <td>
            ${s.item}
            ${s.imagen ? `<img src="${s.imagen}" class="item">` : ""}
          </td>
          <td>${s.precioBase}</td>
          <td>${s.pujaActual}</td>
          <td>${s.ganador || "-"}</td>
          <td data-fin="${s.fin}" data-id="${d.id}">${formato(restante)}</td>
          <td>${historialTxt}</td>
          <td>
            ${restante > 0 && !s.finalizada
              ? `<input type="number" id="puja_${d.id}" placeholder="Cantidad">
                 <button onclick="pujar('${d.id}')">Pujar</button>`
              : "Finalizada"}
          </td>
          ${puedeBorrar ? `<td><button onclick="eliminarSubasta('${d.id}')">ðŸ—‘</button></td>` : ""}
        </tr>
      `;

      if(restante <= 0 && !s.finalizada){
        finalizarSubastaSiAplica(s, d.id);
      }
    });

    iniciarContadoresVivos();
  });
}

/* === Pujar: descuenta saldo inmediato y registra para posible reembolso === */
window.pujar = async (id)=>{
  const user = auth.currentUser;
  const meRef = doc(db,"members",user.uid);
  const meSnap = await getDoc(meRef);
  const me = meSnap.data();

  const subRef = doc(db,"subastas",id);
  const subSnap = await getDoc(subRef);
  const sub = subSnap.data();

  const cantidad = Number(document.getElementById("puja_"+id).value);
  if(!cantidad || cantidad <= 0){
    alert("Introduce una cantidad vÃ¡lida");
    return;
  }
  if(me.totalContribution < cantidad){
    alert("No tienes puntos suficientes");
    return;
  }

  const restanteSeg = Math.max(0, Math.floor((sub.fin - Date.now()) / 1000));
  if(restanteSeg <= 0 || sub.finalizada){
    alert("La subasta ya ha finalizado");
    return;
  }

  // Descontar inmediatamente para reflejar saldo
  await updateDoc(meRef,{ totalContribution: me.totalContribution - cantidad });

  // Registrar puja y actualizar ganador/pujaActual
  const nueva = sub.pujaActual + cantidad;
  const nuevoHistorial = [...(sub.historial || []), { uid:user.uid, jugador: me.name, cantidad }];

  await updateDoc(subRef,{
    pujaActual: nueva,
    ganador: me.name,
    ganadorUid: user.uid,
    historial: nuevoHistorial
  });
};

/* === Eliminar subasta: reembolso a todos los pujadores === */
window.eliminarSubasta = async (id)=>{
  if(!confirm("Â¿Eliminar esta subasta?")) return;

  const subRef = doc(db,"subastas",id);
  const subSnap = await getDoc(subRef);
  const sub = subSnap.data();

  for(const h of sub.historial || []){
    const jugadorRef = doc(db,"members",h.uid);
    const jugadorSnap = await getDoc(jugadorRef);
    const jugadorData = jugadorSnap.data();
    await updateDoc(jugadorRef,{ totalContribution: (jugadorData?.totalContribution ?? 0) + h.cantidad });
  }

  await deleteDoc(subRef);
};

/* === Finalizar subasta: reembolsar no-ganadores, marcar finalizada === */
async function finalizarSubastaSiAplica(sub, id){
  if(sub.finalizada) return;
  const subRef = doc(db,"subastas",id);

  // Si nadie ganÃ³ (no hubo pujas), solo marcar finalizada
  if(!sub.ganadorUid){
    await updateDoc(subRef,{ finalizada: true });
    return;
  }

  // Reembolsar a todos los que no son el ganador
  for(const h of sub.historial || []){
    if(h.uid !== sub.ganadorUid){
      const jugadorRef = doc(db,"members",h.uid);
      const jugadorSnap = await getDoc(jugadorRef);
      const jugadorData = jugadorSnap.data();
      await updateDoc(jugadorRef,{ totalContribution: (jugadorData?.totalContribution ?? 0) + h.cantidad });
    }
  }

  // Marcar finalizada para evitar duplicados
  await updateDoc(subRef,{ finalizada: true });
}

/* === Contador en vivo (no modifica estilos de la tabla) === */
let intervaloContadores;
function iniciarContadoresVivos(){
  if(intervaloContadores) clearInterval(intervaloContadores);
  intervaloContadores = setInterval(async ()=>{
    const tds = document.querySelectorAll("[data-fin]");
    for(const td of tds){
      const fin = Number(td.getAttribute("data-fin"));
      const restante = Math.max(0, Math.floor((fin - Date.now())/1000));
      td.textContent = formato(restante);

      if(restante <= 0){
        const id = td.getAttribute("data-id");
        if(id){
          const subSnap = await getDoc(doc(db,"subastas",id));
          const sub = subSnap.data();
          if(sub) await finalizarSubastaSiAplica(sub, id);
        }
      }
    }
  }, 1000);
}

function formato(s){
  const m = Math.floor(s/60);
  const r = s % 60;
  return `${m}:${r.toString().padStart(2,"0")}`;
}
</script>

</body>
</html>
